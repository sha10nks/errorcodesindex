---
import SectionLayout from '../layouts/SectionLayout.astro';
import QuickNav from './QuickNav.astro';
import ContentGrid from './ContentGrid.astro';
import AdBlock from './AdBlock.astro';
import FAQ from './FAQ.astro';
import { GUIDES } from '../lib/guides/registry';

export interface Props {
  title: string;
  description: string;
  industryKey: 'healthcare' | 'irs-tax' | 'banking' | 'gaming' | 'appliances' | 'systems';
  categoryData?: Array<{
    name: string;
    icon: string;
    count: number;
    url: string;
  }>;
  prefixesOverride?: string[];
  quickNavBasePath?: string;
  showQuickNav?: boolean;
  introContent?: string;
  guideContent?: string;
  Intro?: any;
  Guide?: any;
  faqItems: Array<{
    question: string;
    answerHtml: string;
  }>;
  recentItems: Array<{
    code: string;
    title: string;
    description: string;
    category: string;
    publishDate: string;
    url: string;
  }>;
  featuredItems: Array<{
    code: string;
    title: string;
    description: string;
    category: string;
    publishDate: string;
    url: string;
  }>;
  crumbs: Array<{
    label: string;
    href: string;
  }>;
}

const { 
  title, 
  description, 
  industryKey, 
  categoryData, 
  prefixesOverride,
  quickNavBasePath,
  showQuickNav = true,
  introContent, 
  guideContent, 
  Intro,
  Guide,
  faqItems, 
  recentItems, 
  featuredItems, 
  crumbs 
} = Astro.props;

const prefixes = {
  'healthcare': ['EOB', 'CO-', 'PR-', 'OA-', 'PI-', 'CARC/RARC'],
  'irs-tax': ['CP-', 'LT-', 'TC-', '1040', 'W-2', '1099'],
  'banking': ['05', '12', '14', '51', '54', '91', 'R0-'],
  'gaming': ['WS-', 'NP-', 'SU-', 'CE-', 'Numeric Codes'],
  'appliances': ['Dishwashers', 'Refrigerators', 'Washers', 'General Appliances'],
  'systems': ['0x', 'Error', 'POST', 'TPM', 'DHCP', 'B200']
};

const quickNavPrefixes = prefixesOverride ?? prefixes[industryKey];

const sortByPublishDateDesc = <T extends { publishDate: string; code: string }>(items: T[]) =>
  items
    .slice()
    .sort((a, b) => {
      const t = Date.parse(b.publishDate) - Date.parse(a.publishDate);
      if (t !== 0) return t;
      return (a.code || '').localeCompare(b.code || '', 'en', { numeric: true });
    });

const recentList = sortByPublishDateDesc(recentItems).slice(0, 18);
const featuredList = featuredItems.slice(0, 12);

const hasGridContent = recentList.length > 0 || featuredList.length > 0;
const hasFaq = faqItems.length > 0;

const guidesCategoryKey = industryKey;
const popularGuides = GUIDES.filter((g) => g.categoryKey === guidesCategoryKey).slice(0, 6);
---

<SectionLayout title={title} description={description} crumbs={crumbs}>
  <div class="not-prose space-y-14">
    <section>
      <div class="max-w-4xl mx-auto">
        <div class="prose prose-invert prose-slate prose-lg max-w-none">
          {Intro ? <Intro /> : <div set:html={introContent} />}
        </div>

        <div class="mt-8 p-6 rounded-xl border border-brand-border bg-brand-surface/50">
          <h2 class="text-lg font-semibold text-slate-100 mb-4">What you'll find here</h2>
          <ul class="space-y-2 text-slate-300">
            {industryKey === 'healthcare' && (
              <>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Denial and adjustment codes grouped by the way payers communicate decisions</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Eligibility, authorization, and documentation-related error references</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Practical next steps to fix common claim and remittance issues</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Links to the full index and the newest pages added to the directory</span>
                </li>
              </>
            )}
            {industryKey === 'irs-tax' && (
              <>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>IRS notices, letter codes, and common refund/processing indicators</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Transcript and transaction-code references explained in plain language</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Actionable checklists to confirm identity, filing status, and next steps</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Direct links to recently indexed pages and a curated set of common codes</span>
                </li>
              </>
            )}
            {industryKey === 'banking' && (
              <>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Card and payment-network response codes used by issuers and processors</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>ACH return codes and transfer failures explained with likely causes</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Resolution steps for merchants and consumers, organized by scenario</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Featured codes plus the newest entries added to the directory</span>
                </li>
              </>
            )}
            {industryKey === 'gaming' && (
              <>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Console and platform errors from major networks and launchers</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Connectivity, store, update, and licensing issues mapped to fixes</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Common codes curated for fast diagnosis, plus newly indexed pages</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Short, practical troubleshooting steps you can apply immediately</span>
                </li>
              </>
            )}
            {industryKey === 'appliances' && (
              <>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Appliance-type hubs that break down brands, models, and series</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Diagnostic codes and troubleshooting notes organized for scanability</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Recently indexed pages to surface new models and code families</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Practical guidance on interpreting codes before calling service</span>
                </li>
              </>
            )}
            {industryKey === 'systems' && (
              <>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Operating system, firmware, and device codes mapped to plain-language meanings</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Safe troubleshooting checklists that avoid risky or invasive instructions</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Related-code links to help you move between nearby prefixes and families</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-brand-primary mt-1">✓</span>
                  <span>Featured and recently indexed pages for fast discovery</span>
                </li>
              </>
            )}
          </ul>
        </div>

        <div class="mt-8 p-6 rounded-xl border border-brand-border bg-brand-surface/50">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-lg font-semibold text-slate-100">Popular Guides</h2>
              <p class="mt-2 text-sm text-slate-400">Fast, high-signal walkthroughs that link back into the directory.</p>
            </div>
            <a href={`/guides/${guidesCategoryKey}/`} class="hidden sm:inline-flex text-sm font-semibold text-brand-primary hover:underline">
              View all
            </a>
          </div>
          <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
            {popularGuides.map((g) => (
              <a
                href={`/guides/${g.categoryKey}/${g.slug}/`}
                class="rounded-xl border border-brand-border/70 bg-brand-dark/30 px-4 py-3 text-slate-200 hover:bg-brand-dark/50 transition-colors"
              >
                <div class="text-sm font-semibold">{g.title}</div>
                <div class="mt-1 text-xs text-slate-400 line-clamp-2">{g.description}</div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </section>

    <section class="border-t border-brand-border/60 pt-14">
      {showQuickNav ? (
        <QuickNav prefixes={quickNavPrefixes} industryKey={industryKey} basePath={quickNavBasePath} />
      ) : null}
    </section>

    {(industryKey === 'appliances' || industryKey === 'systems') && categoryData && (
      <section id="browse-by-category" class="border-t border-brand-border/60 pt-14 scroll-mt-28">
        <div class="max-w-6xl mx-auto">
          <div class="flex items-end justify-between mb-8">
            <div>
              <h2 class="text-2xl font-bold text-slate-100">Browse by Category</h2>
              <p class="mt-3 text-slate-400 max-w-3xl">
                {industryKey === 'appliances'
                  ? 'Start with an appliance type, then drill into brand and model/series hubs. Every link is crawlable and organized to keep troubleshooting fast.'
                  : 'Start with a systems or device subcategory, then browse the most common codes and the newest additions. Every link is crawlable and designed for fast troubleshooting.'}
              </p>
            </div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            {categoryData.map((cat) => (
              <a
                href={cat.url}
                class="group rounded-2xl border border-brand-border bg-brand-surface/60 p-5 hover:border-brand-primary/50 hover:shadow-glow transition-all"
              >
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="h-11 w-11 rounded-xl bg-brand-dark/60 border border-brand-border flex items-center justify-center text-xl">
                      {cat.icon}
                    </div>
                    <div>
                      <div class="text-sm font-semibold text-slate-100 group-hover:text-white">{cat.name}</div>
                      <div class="text-xs text-slate-500 mt-1">{cat.count.toLocaleString()} codes</div>
                    </div>
                  </div>
                  <span class="text-slate-500 group-hover:text-brand-primary transition-colors">→</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    {hasGridContent && (
      <section class="border-t border-brand-border/60 pt-14">
        <ContentGrid recentItems={recentList} featuredItems={featuredList} layout="two-column" />
      </section>
    )}

    <section class="border-t border-brand-border/60 pt-14">
      <AdBlock adSlot={`${industryKey}-hub`} height={280} responsive={true} />
    </section>

    <section class="border-t border-brand-border/60 pt-14 space-y-12">
      <div class="max-w-4xl mx-auto">
        <div class="prose prose-invert prose-slate prose-lg max-w-none">
          {Guide ? <Guide /> : <div set:html={guideContent} />}
        </div>
      </div>

      {hasFaq && (
        <div class="max-w-4xl mx-auto">
          <FAQ items={faqItems} />
        </div>
      )}
    </section>
  </div>
</SectionLayout>
