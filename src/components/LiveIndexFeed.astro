---
import { getHomeFeed } from '../lib/homeFeed';

const { trendingCodes, recentlyIndexed, prefixBuckets } = await getHomeFeed();

const industryLabel = (industry: string) => {
  if (industry === 'irs-tax') return 'IRS / Tax';
  if (industry === 'healthcare') return 'Healthcare';
  if (industry === 'banking') return 'Banking';
  if (industry === 'gaming') return 'Gaming';
  if (industry === 'appliances') return 'Appliances';
  return industry;
};
---

<section aria-labelledby="live-index-feed" class="pt-14 border-t border-brand-border/60">
  <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between mb-10">
    <div>
      <h2 id="live-index-feed" class="text-3xl font-bold text-white tracking-tight">Live Index Feed</h2>
      <p class="mt-3 text-slate-400 text-lg">Trending lookups, newest additions, and quick prefix navigation.</p>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-2 items-stretch">
    <section class="h-full rounded-2xl border border-brand-border/60 bg-brand-surface/70 backdrop-blur-sm shadow-card overflow-hidden group hover:border-brand-primary/30 transition-colors">
      <div class="px-6 pt-6 pb-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="h-10 w-10 rounded-xl bg-brand-primary/10 text-brand-primary grid place-items-center border border-brand-primary/20">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2c.5 4-2 5.5-2 8 0 1.5 1 3 2 3s2-1.5 2-3c0-2.5-2.5-4-2-8z" />
              <path d="M6 14c0 4 3 8 6 8s6-4 6-8c0-2-1-4-3-5" />
            </svg>
          </span>
          <h3 class="text-sm font-semibold tracking-wide text-slate-100 uppercase">Trending Error Codes</h3>
        </div>
        <span class="text-xs text-slate-500 font-mono">{trendingCodes.length}</span>
      </div>

      <ul class="px-2 pb-4" role="list" data-feed="trending">
        {trendingCodes.map((it) => (
          <li>
            <a
              href={it.url}
              class="feed-row flex items-start gap-3 rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-brand-dark/40 hover:text-white transition-colors"
            >
              <span class="mt-0.5 font-mono text-xs font-bold text-brand-primary bg-brand-primary/10 px-2 py-1 rounded border border-brand-primary/20 shrink-0">
                {it.code}
              </span>
              <span class="flex-1 text-slate-400 group-hover:text-slate-200 font-medium leading-snug">{it.shortLabel}</span>
              <span class="mt-0.5 text-[10px] uppercase tracking-wider text-slate-500 border border-brand-border/60 px-2 py-1 rounded-full shrink-0">
                {industryLabel(it.industry)}
              </span>
            </a>
          </li>
        ))}
      </ul>
    </section>

    <section class="h-full rounded-2xl border border-brand-border/60 bg-brand-surface/70 backdrop-blur-sm shadow-card overflow-hidden group hover:border-brand-primary/30 transition-colors">
      <div class="px-6 pt-6 pb-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="h-10 w-10 rounded-xl bg-brand-accent/10 text-brand-accent grid place-items-center border border-brand-accent/20">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 7v5l3 2" />
              <circle cx="12" cy="12" r="9" />
            </svg>
          </span>
          <h3 class="text-sm font-semibold tracking-wide text-slate-100 uppercase">Recently Indexed</h3>
        </div>
        <span class="text-xs text-slate-500 font-mono">{recentlyIndexed.length}</span>
      </div>

      <ul class="px-2 pb-4" role="list">
        {recentlyIndexed.map((it, idx) => (
          <li>
            <a
              href={it.url}
              class="flex items-start gap-3 rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-brand-dark/40 hover:text-white transition-colors"
            >
              <span class="mt-0.5 font-mono text-xs font-bold text-brand-primary bg-brand-primary/10 px-2 py-1 rounded border border-brand-primary/20 shrink-0">
                {it.code}
              </span>
              <span class="flex-1 text-slate-400 hover:text-slate-200 font-medium leading-snug">{it.shortLabel}</span>
              {idx < 3 ? (
                <span class="mt-0.5 text-[10px] uppercase tracking-wider text-brand-dark bg-brand-primary px-2 py-1 rounded-full shrink-0">
                  New
                </span>
              ) : (
                <span class="mt-0.5 text-[10px] uppercase tracking-wider text-slate-500 border border-brand-border/60 px-2 py-1 rounded-full shrink-0">
                  {industryLabel(it.industry)}
                </span>
              )}
            </a>
          </li>
        ))}
      </ul>
    </section>
  </div>
</section>

<style>
  .feed-row[data-active="true"] {
    background: rgba(0, 0, 0, 0.35);
    box-shadow: inset 0 0 0 1px rgba(16, 208, 97, 0.25);
  }

  @media (prefers-reduced-motion: reduce) {
    .feed-row {
      transition: none;
    }
  }
</style>

<script>
  const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
  if (!prefersReduced) {
    const rows = Array.from(document.querySelectorAll('[data-feed="trending"] .feed-row'));
    if (rows.length > 1) {
      let i = 0;
      rows[i].setAttribute('data-active', 'true');
      window.setInterval(() => {
        rows[i].removeAttribute('data-active');
        i = (i + 1) % rows.length;
        rows[i].setAttribute('data-active', 'true');
      }, 3000);
    }
  }
</script>
