---
import { INDUSTRIES } from '../utils/site';
import { GUIDE_CATEGORIES, getGuidesByCategory } from '../lib/guides/registry';

export interface Props {
  currentPath: string;
  overlay?: boolean;
}

const { currentPath, overlay = false } = Astro.props;

// Base classes
const baseHeaderClass = "fixed top-0 left-0 w-full z-50 transition-all duration-300 ease-in-out border-b";

// Initial state classes (server-side rendered)
const initialClass = overlay 
  ? "border-transparent bg-transparent backdrop-blur-none" 
  : "border-brand-border bg-brand-dark/80 backdrop-blur-md";

const linkClass = "text-slate-300 hover:text-white transition-colors hover:bg-white/5 px-3 py-2 rounded-lg";

const guidesByCategory = GUIDE_CATEGORIES.map((category) => ({
  ...category,
  guides: getGuidesByCategory(category.key),
}));

// Column configuration for mega menu
const col1Categories = ['healthcare', 'gaming'];
const col2Categories = ['irs-tax', 'banking', 'appliances'];
const col3Categories = ['systems'];

const menuColumns = [
  col1Categories.map(key => guidesByCategory.find(c => c.key === key)).filter(Boolean),
  col2Categories.map(key => guidesByCategory.find(c => c.key === key)).filter(Boolean),
  col3Categories.map(key => guidesByCategory.find(c => c.key === key)).filter(Boolean),
];
---

<header id="site-header" class={`${baseHeaderClass} ${initialClass}`} data-overlay={overlay}>
  <div class="mx-auto flex max-w-7xl items-center px-6 py-4 md:py-5 transition-all duration-300" id="header-container">
    {/* Logo */}
    <a href="/" class="flex items-center gap-3 text-lg font-semibold text-slate-100 hover:text-white transition-colors mr-12 group">
      <img 
        src="/Logo.svg" 
        alt="ErrorCodesIndex" 
        class="h-9 md:h-14 w-auto object-contain transition-transform duration-300 group-hover:scale-105"
        width="200"
        height="56"
        loading="eager"
        decoding="async"
      />
    </a>

    {/* Desktop Navigation - Left Aligned */}
    <nav aria-label="Primary" class="hidden items-center gap-1 text-sm font-medium md:flex">
      <a href="/about/" class={linkClass}>About</a>
      
      <details class="group relative">
        <summary class={`flex cursor-pointer list-none items-center gap-1 ${linkClass}`}>
          <span>Industries</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 transition-transform group-open:rotate-180 opacity-70">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </summary>
        <div id="industries-dropdown-menu" class="absolute left-0 top-full mt-2 w-72 origin-top-left rounded-2xl border border-brand-border/50 bg-[#0A0A0B]/95 backdrop-blur-2xl shadow-2xl ring-1 ring-white/5 focus:outline-none z-50 animate-in fade-in slide-in-from-top-2 duration-200 p-4">
          <div class="space-y-4">
            <div class="block text-xs font-bold uppercase tracking-widest text-brand-primary mb-2 px-2">
              Browse by Industry
            </div>
            <ul class="space-y-1">
              {INDUSTRIES.map((it) => (
                <li>
                  <a class="block rounded-lg px-2 py-2 text-sm font-semibold text-slate-200 hover:text-white hover:bg-white/5 transition-all duration-200 group" href={it.href}>
                    <span class="group-hover:translate-x-1 transition-transform inline-block">
                      {it.label}
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </details>

      <details class="group">
        <summary class={`flex cursor-pointer list-none items-center gap-1 ${linkClass}`}>
          <span>Guides</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 transition-transform group-open:rotate-180 opacity-70">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </summary>
        
        {/* Mega Menu Dropdown */}
        <div id="guides-dropdown-menu" class="absolute left-1/2 top-full -translate-x-1/2 mt-4 w-[95vw] max-w-6xl max-h-[calc(100vh-120px)] overflow-y-auto custom-scrollbar origin-top rounded-2xl border border-brand-border/50 bg-[#0A0A0B]/95 backdrop-blur-2xl shadow-2xl ring-1 ring-white/5 focus:outline-none z-50 animate-in fade-in slide-in-from-top-2 duration-200 p-8">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-x-12 gap-y-10">
            {menuColumns.map((col, colIndex) => (
              <div class="space-y-10">
                {col.map((category) => (
                  <div class="space-y-4">
                    <a href={category.href} class="block text-xs font-bold uppercase tracking-widest text-brand-primary hover:text-brand-accent transition-colors mb-4">
                      {category.label}
                    </a>
                    <ul class="space-y-5">
                      {category.guides.map((g) => (
                        <li>
                          <a href={`${category.href}${g.slug}/`} class="group block">
                            <div class="text-sm font-semibold text-slate-200 group-hover:text-white transition-colors mb-1">
                              {g.title}
                            </div>
                          </a>
                        </li>
                      ))}
                    </ul>
                    {/* View All Link for Category */}
                    <a href={category.href} class="inline-flex items-center gap-1 text-xs font-medium text-brand-primary/80 hover:text-brand-primary transition-colors mt-2 group/link">
                      View all {category.label}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 transition-transform group-hover/link:translate-x-0.5">
                        <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                      </svg>
                    </a>
                  </div>
                ))}
              </div>
            ))}
          </div>
          
          {/* Footer of Mega Menu */}
          <div class="mt-8 pt-6 border-t border-white/5 flex items-center justify-between">
            <div class="text-xs text-slate-500">
              Expert-verified troubleshooting guides for complex system errors.
            </div>
            <a href="/guides/" class="text-xs font-semibold text-white hover:text-brand-primary transition-colors flex items-center gap-2">
              Browse all guides
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
              </svg>
            </a>
          </div>
        </div>
      </details>
      
      <a href="/contact/" class={linkClass}>Contact</a>
    </nav>

    {/* Mobile Menu Trigger - Right Aligned */}
    <button
      id="mobile-menu-trigger"
      class="ml-auto flex items-center justify-center rounded-lg border border-brand-border bg-brand-surface/50 backdrop-blur px-3 py-2 text-slate-300 hover:bg-brand-border hover:text-white transition-colors md:hidden"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="mobile-menu-overlay"
    >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
      </svg>
    </button>

    {/* Mobile Menu Overlay */}
    <div
      id="mobile-menu-backdrop"
      class="fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"
      aria-hidden="true"
    ></div>

    <div
      id="mobile-menu-overlay"
      class="fixed top-0 right-0 z-[100] h-[100dvh] w-[90vw] max-w-[360px] flex flex-col bg-brand-dark border-l border-brand-border shadow-2xl transition-transform duration-300 translate-x-full md:hidden"
      role="dialog"
      aria-modal="true"
      aria-label="Site Navigation"
    >
      <div class="flex items-center justify-between px-6 py-5 border-b border-brand-border/50 bg-brand-dark flex-shrink-0">
        <span class="text-lg font-bold text-slate-100">Menu</span>
        <button
          id="mobile-menu-close"
          class="rounded-lg p-2 text-slate-400 hover:bg-white/10 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-brand-primary"
          aria-label="Close menu"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <nav class="flex-1 overflow-y-auto overflow-x-hidden px-6 py-6 overscroll-contain">
        <ul class="space-y-6 pb-20">
          <li>
            <a href="/about/" class="block py-2 text-lg font-medium text-slate-300 hover:text-brand-primary transition-colors focus:outline-none focus:text-brand-primary">About</a>
          </li>
          
          <li class="space-y-3">
            <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Industries</div>
            <ul class="space-y-2 pl-4 border-l border-brand-border/50">
              {INDUSTRIES.map((it) => (
                <li>
                  <a href={it.href} class="block py-2 text-base text-slate-300 hover:text-brand-primary transition-colors focus:outline-none focus:text-brand-primary">
                    {it.label}
                  </a>
                </li>
              ))}
            </ul>
          </li>

          <li class="space-y-3">
            <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Guides</div>
            <ul class="space-y-2 pl-4 border-l border-brand-border/50">
              <li>
                <a href="/guides/" class="block py-2 text-base text-slate-300 hover:text-brand-primary transition-colors focus:outline-none focus:text-brand-primary">
                  All guides
                </a>
              </li>
              {guidesByCategory.map((category) => (
                <li>
                  <details class="group">
                    <summary class="flex cursor-pointer list-none items-center justify-between gap-3 py-2 text-base text-slate-300 hover:text-brand-primary transition-colors">
                      <span>{category.label}</span>
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 transition-transform group-open:rotate-180 opacity-60">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                      </svg>
                    </summary>
                    <div class="mt-1 space-y-2 pl-3 border-l border-brand-border/30">
                      <a href={category.href} class="block py-1.5 text-sm font-semibold text-brand-primary hover:text-brand-accent transition-colors">
                        View all {category.label}
                      </a>
                      <ul class="space-y-1">
                        {category.guides.map((g) => (
                          <li>
                            <a href={`${category.href}${g.slug}/`} class="block rounded-lg px-2 py-1.5 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors">
                              {g.title}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </details>
                </li>
              ))}
            </ul>
          </li>

          <li>
            <a href="/contact/" class="block py-2 text-lg font-medium text-slate-300 hover:text-brand-primary transition-colors focus:outline-none focus:text-brand-primary">Contact</a>
          </li>
        </ul>
      </nav>
      
      <div class="p-6 border-t border-brand-border/50 bg-brand-surface/30 flex-shrink-0">
        <p class="text-xs text-slate-500 text-center">
          Â© {new Date().getFullYear()} ErrorCodesIndex. All rights reserved.
        </p>
      </div>
    </div>
  </div>
</header>

<script>
  // Header Scroll Logic
  const header = document.getElementById('site-header');
  const container = document.getElementById('header-container');
  const isOverlay = header?.dataset.overlay === 'true';

  const updateHeader = () => {
    if (!header || !container) return;
    const scrolled = window.scrollY > 20;

    if (scrolled) {
      header.classList.add('bg-brand-dark/90', 'backdrop-blur-xl', 'border-brand-border', 'shadow-lg');
      header.classList.remove('border-transparent', 'bg-transparent', 'backdrop-blur-none', 'bg-brand-dark/80', 'backdrop-blur-md');
      container.classList.remove('py-6');
      container.classList.add('py-4');
    } else {
      container.classList.remove('py-4');
      container.classList.add('py-6');
      
      if (isOverlay) {
        header.classList.add('border-transparent', 'bg-transparent', 'backdrop-blur-none');
        header.classList.remove('bg-brand-dark/90', 'backdrop-blur-xl', 'border-brand-border', 'shadow-lg');
      } else {
        header.classList.add('border-brand-border', 'bg-brand-dark/80', 'backdrop-blur-md');
        header.classList.remove('bg-brand-dark/90', 'backdrop-blur-xl', 'shadow-lg');
      }
    }
  };

  window.addEventListener('scroll', updateHeader);
  updateHeader();

  // Mobile Menu Logic
  const menuTrigger = document.getElementById('mobile-menu-trigger');
  const menuClose = document.getElementById('mobile-menu-close');
  const menuOverlay = document.getElementById('mobile-menu-overlay');
  const menuBackdrop = document.getElementById('mobile-menu-backdrop');
  
  // Focus Trap Logic
  const focusableElementsString = 'a[href], button:not([disabled]), input:not([disabled]), textarea:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';
  let firstFocusableElement: HTMLElement | null = null;
  let lastFocusableElement: HTMLElement | null = null;

  function trapFocus(e: KeyboardEvent) {
    if (e.key === 'Tab') {
      if (e.shiftKey) { // Shift + Tab
        if (document.activeElement === firstFocusableElement) {
          e.preventDefault();
          lastFocusableElement?.focus();
        }
      } else { // Tab
        if (document.activeElement === lastFocusableElement) {
          e.preventDefault();
          firstFocusableElement?.focus();
        }
      }
    }
  }

  function toggleMenu() {
    if (!menuOverlay || !menuBackdrop || !menuTrigger) return;
    const isClosed = menuOverlay.classList.contains('translate-x-full');
    
    if (isClosed) {
      // Open Menu
      menuOverlay.classList.remove('translate-x-full');
      menuBackdrop.classList.remove('opacity-0', 'pointer-events-none');
      document.body.style.overflow = 'hidden'; // Lock scroll
      menuTrigger.setAttribute('aria-expanded', 'true');
      
      // Setup Focus Trap
      const focusableContent = menuOverlay.querySelectorAll(focusableElementsString);
      if (focusableContent.length) {
        firstFocusableElement = focusableContent[0] as HTMLElement;
        lastFocusableElement = focusableContent[focusableContent.length - 1] as HTMLElement;
        firstFocusableElement.focus();
        document.addEventListener('keydown', trapFocus);
      }
    } else {
      // Close Menu
      menuOverlay.classList.add('translate-x-full');
      menuBackdrop.classList.add('opacity-0', 'pointer-events-none');
      document.body.style.overflow = ''; // Unlock scroll
      menuTrigger.setAttribute('aria-expanded', 'false');
      menuTrigger.focus(); // Return focus
      document.removeEventListener('keydown', trapFocus);
    }
  }

  menuTrigger?.addEventListener('click', toggleMenu);
  menuClose?.addEventListener('click', toggleMenu);
  menuBackdrop?.addEventListener('click', toggleMenu);
  
  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !menuOverlay?.classList.contains('translate-x-full')) {
      toggleMenu();
    }
  });
  
  // Close menu when clicking links
  const menuLinks = menuOverlay?.querySelectorAll('a');
  menuLinks?.forEach(link => {
    link.addEventListener('click', () => {
       if (!menuOverlay?.classList.contains('translate-x-full')) {
         toggleMenu();
       }
    });
  });

  // Desktop Dropdown Scroll Lock & Hover Behavior
  const guidesDropdown = document.getElementById('guides-dropdown-menu');
  const industriesDropdown = document.getElementById('industries-dropdown-menu');
  const dropdowns = [guidesDropdown, industriesDropdown];

  dropdowns.forEach(dropdown => {
    if (!dropdown) return;
    
    const details = dropdown.closest('details');
    if (!details) return;

    let timeoutId: any;

    // Open on mouse enter
    const openMenu = () => {
      clearTimeout(timeoutId);
      details.open = true;
      if (dropdown === guidesDropdown) {
        document.body.style.overflow = 'hidden';
      }
    };

    // Close on mouse leave
    const closeMenu = () => {
      timeoutId = setTimeout(() => {
        details.open = false;
        if (dropdown === guidesDropdown) {
          document.body.style.overflow = '';
        }
      }, 100); // Small delay for better UX
    };

    // Add listeners to summary (the trigger)
    const summary = details.querySelector('summary');
    if (summary) {
      summary.addEventListener('mouseenter', openMenu);
      summary.addEventListener('mouseleave', closeMenu);
    }

    // Add listeners to dropdown content
    dropdown.addEventListener('mouseenter', openMenu);
    dropdown.addEventListener('mouseleave', closeMenu);

    // Reset overflow if details is closed manually or by other means
    details.addEventListener('toggle', () => {
      if (!details.open && dropdown === guidesDropdown) {
        document.body.style.overflow = '';
      }
    });
  });
</script>
