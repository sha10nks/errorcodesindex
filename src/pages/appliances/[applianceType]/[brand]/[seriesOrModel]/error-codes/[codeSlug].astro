---
import { getCollection } from 'astro:content';
import { breadcrumbSchema, techArticleSchema } from '../../../../../../utils/schema';
import { pickRelatedEntries } from '../../../../../../utils/related';
import { parseAuthoritySectionsFromBody } from '../../../../../../utils/authority';
import { pickGuidesForCode, pickHubsForCode } from '../../../../../../lib/guides/learnMore';
import ErrorCodeDetailLayout from '../../../../../../components/ErrorCodeDetailLayout.astro';

export async function getStaticPaths() {
  const entries = await getCollection('applianceCodes');
  return entries.map((e) => {
    const codeSlug = e.slug.split('/').slice(-1)[0];
    return {
      params: {
        applianceType: e.data.applianceType,
        brand: e.data.brand,
        seriesOrModel: e.data.seriesOrModel,
        codeSlug,
      },
      props: { entryId: e.id },
    };
  });
}

const { applianceType, brand, seriesOrModel, codeSlug } = Astro.params;
const { entryId } = Astro.props;

if (!applianceType || !brand || !seriesOrModel || !codeSlug) throw new Error('Missing params');

const entries = await getCollection('applianceCodes');
const entry = entries.find((e) => e.id === entryId);
if (!entry) throw new Error('Missing entry');

const pageTitle = `${entry.data.code} — Meaning (Appliances Error Code)`;

const parsed = parseAuthoritySectionsFromBody(entry.body);
const summaryText = (entry.data.summary || parsed.whatMeans[0] || entry.data.shortLabel).trim();
const description = summaryText.length > 10 ? summaryText : `What ${entry.data.code} means for appliances.`;

const canonicalPath = `/appliances/${applianceType}/${brand}/${seriesOrModel}/error-codes/${codeSlug}/`;
const canonicalUrl = new URL(canonicalPath, Astro.site).toString();

const crumbs = [
  { label: 'Home', href: '/' },
  { label: 'Appliances', href: '/appliances/' },
  { label: applianceType.replace(/-/g, ' '), href: `/appliances/${applianceType}/` },
  { label: brand.replace(/-/g, ' '), href: `/appliances/${applianceType}/${brand}/` },
  { label: seriesOrModel.replace(/-/g, ' '), href: `/appliances/${applianceType}/${brand}/${seriesOrModel}/` },
  { label: entry.data.code, href: canonicalPath },
];

const currentText = `${entry.data.shortLabel} ${entry.data.summary || ''} ${(parsed.whatMeans[0] || '').slice(0, 220)}`;
const relatedEntries = pickRelatedEntries(entries as any, {
  industryKey: 'appliances',
  currentSlug: entry.slug,
  currentCode: entry.data.code,
  currentText,
  mentionedCodes: parsed.mentionedRelatedCodes,
  appliance: { applianceType, brand, seriesOrModel },
  max: 8,
});

const relatedItems = relatedEntries.map((rel: any) => {
  const relCodeSlug = rel.slug.split('/').slice(-1)[0];
  return {
    code: rel.data.code,
    shortLabel: rel.data.shortLabel,
    url: `/appliances/${rel.data.applianceType}/${rel.data.brand}/${rel.data.seriesOrModel}/error-codes/${relCodeSlug}/`,
  };
});

const learnMoreHubs = pickHubsForCode({ industryKey: 'appliances', applianceType, brand, seriesOrModel });
const learnMoreGuides = pickGuidesForCode({ industryKey: 'appliances', code: entry.data.code, applianceType });

const schema = [
  breadcrumbSchema(crumbs, canonicalUrl),
  techArticleSchema({
    headline: `${entry.data.code} — ${entry.data.shortLabel}`,
    description,
    canonicalUrl,
    industryLabel: 'Appliances',
    code: entry.data.code,
    dateModified: entry.data.lastmod,
    keywords: [entry.data.code, 'Appliances', applianceType, brand],
  }),
];

const lastUpdatedLabel = new Date(entry.data.lastmod).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});
---

<ErrorCodeDetailLayout
  pageTitle={pageTitle}
  description={description}
  canonicalPath={canonicalPath}
  crumbs={crumbs}
  schema={schema}
  industryLabel="Appliances"
  industryBadge="Appliances Error Code"
  code={entry.data.code}
  shortLabel={entry.data.shortLabel}
  sectionLabel={parsed.sectionLabel}
  systemLabel={parsed.systemLabel}
  lastUpdatedLabel={lastUpdatedLabel}
  summary={summaryText}
  whatMeans={parsed.whatMeans}
  whereSeen={parsed.whereSeen}
  whyAppears={parsed.whyAppears}
  happensNext={parsed.happensNext}
  notThis={parsed.notThis}
  troubleshooting={parsed.troubleshooting}
  notes={parsed.notes}
  relatedItems={relatedItems}
  learnMoreHubs={learnMoreHubs}
  learnMoreGuides={learnMoreGuides}
/>
