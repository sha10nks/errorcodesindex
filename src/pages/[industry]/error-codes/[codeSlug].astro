---
import { getCollection } from 'astro:content';
import { INDUSTRIES } from '../../../utils/site';
import { breadcrumbSchema, techArticleSchema } from '../../../utils/schema';
import { pickRelatedEntries } from '../../../utils/related';
import { parseAuthoritySectionsFromBody } from '../../../utils/authority';
import ErrorCodeDetailLayout from '../../../components/ErrorCodeDetailLayout.astro';

export async function getStaticPaths() {
  const industries = ['healthcare', 'irs-tax', 'banking', 'gaming'];
  const paths = [];
  for (const industry of industries) {
    const collectionName =
      industry === 'healthcare'
        ? 'healthcareCodes'
        : industry === 'irs-tax'
          ? 'irsTaxCodes'
          : industry === 'banking'
            ? 'bankingCodes'
            : 'gamingCodes';
    const entries = await getCollection(collectionName);
    for (const e of entries) {
      paths.push({ params: { industry, codeSlug: e.slug }, props: { entryId: e.id, collectionName } });
    }
  }
  return paths;
}

const { industry, codeSlug } = Astro.params;
const { entryId, collectionName } = Astro.props;

if (!industry || !codeSlug) throw new Error('Missing route params');

const industryMeta = INDUSTRIES.find((i) => i.key === industry);
if (!industryMeta || industryMeta.key === 'appliances') throw new Error('Unsupported industry');

const entries = await getCollection(collectionName);
const entry = entries.find((e) => e.id === entryId || e.slug === codeSlug);
if (!entry) throw new Error('Missing entry');

const pageTitle = `${entry.data.code} — Meaning (${industryMeta.label} Error Code)`;

const parsed = parseAuthoritySectionsFromBody(entry.body);
const summaryText = (entry.data.summary || parsed.whatMeans[0] || entry.data.shortLabel).trim();
const description = summaryText.length > 10 ? summaryText : `What ${entry.data.code} means in ${industryMeta.label}.`;

const crumbs = [
  { label: 'Home', href: '/' },
  { label: industryMeta.label, href: industryMeta.href },
  { label: 'Error Codes', href: `/${industry}/error-codes/` },
  { label: entry.data.code, href: `/${industry}/error-codes/${entry.slug}/` },
];

const canonicalPath = `/${industry}/error-codes/${entry.slug}/`;
const canonicalUrl = new URL(canonicalPath, Astro.site).toString();

const currentText = `${entry.data.shortLabel} ${entry.data.summary || ''} ${(parsed.whatMeans[0] || '').slice(0, 220)}`;
const relatedEntries = pickRelatedEntries(entries as any, {
  industryKey: industry,
  currentSlug: entry.slug,
  currentCode: entry.data.code,
  currentText,
  mentionedCodes: parsed.mentionedRelatedCodes,
  max: 8,
});

const relatedItems = relatedEntries.map((rel: any) => ({
  code: rel.data.code,
  shortLabel: rel.data.shortLabel,
  url: `/${industry}/error-codes/${rel.slug}/`,
}));

const schema = [
  breadcrumbSchema(crumbs, canonicalUrl),
  techArticleSchema({
    headline: `${entry.data.code} — ${entry.data.shortLabel}`,
    description,
    canonicalUrl,
    industryLabel: industryMeta.label,
    code: entry.data.code,
    dateModified: entry.data.lastmod,
    keywords: [entry.data.code, industryMeta.label, industry],
  }),
];

const lastUpdatedLabel = new Date(entry.data.lastmod).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});
---

<ErrorCodeDetailLayout
  pageTitle={pageTitle}
  description={description}
  canonicalPath={canonicalPath}
  crumbs={crumbs}
  schema={schema}
  industryLabel={industryMeta.label}
  industryBadge={`${industryMeta.label} Error Code`}
  code={entry.data.code}
  shortLabel={entry.data.shortLabel}
  sectionLabel={parsed.sectionLabel}
  systemLabel={parsed.systemLabel}
  lastUpdatedLabel={lastUpdatedLabel}
  summary={summaryText}
  whatMeans={parsed.whatMeans}
  whereSeen={parsed.whereSeen}
  whyAppears={parsed.whyAppears}
  happensNext={parsed.happensNext}
  notThis={parsed.notThis}
  troubleshooting={parsed.troubleshooting}
  notes={parsed.notes}
  relatedItems={relatedItems}
/>
