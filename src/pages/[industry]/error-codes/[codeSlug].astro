---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import AdSlot from '../../../components/AdSlot.astro';
import { INDUSTRIES } from '../../../utils/site';
import { breadcrumbSchema, webPageSchema } from '../../../utils/schema';
import { pickRelatedSlugs } from '../../../utils/related';

export async function getStaticPaths() {
  const industries = ['healthcare', 'irs-tax', 'banking', 'gaming'];
  const paths = [];
  for (const industry of industries) {
    const collectionName =
      industry === 'healthcare'
        ? 'healthcareCodes'
        : industry === 'irs-tax'
          ? 'irsTaxCodes'
          : industry === 'banking'
            ? 'bankingCodes'
            : 'gamingCodes';
    const entries = await getCollection(collectionName);
    for (const e of entries) {
      paths.push({ params: { industry, codeSlug: e.slug }, props: { entryId: e.id, collectionName } });
    }
  }
  return paths;
}

const { industry, codeSlug } = Astro.params;
const { entryId, collectionName } = Astro.props;

if (!industry || !codeSlug) throw new Error('Missing route params');

const industryMeta = INDUSTRIES.find((i) => i.key === industry);
if (!industryMeta || industryMeta.key === 'appliances') throw new Error('Unsupported industry');

const entries = await getCollection(collectionName);
const entry = entries.find((e) => e.id === entryId || e.slug === codeSlug);
if (!entry) throw new Error('Missing entry');

const { Content } = await entry.render();

const pageTitle = `${entry.data.code} Meaning â€“ ${industryMeta.label} Error Code`;
const description = `Official reference for ${entry.data.code} (${industryMeta.label}). Includes verbatim source content and related ${industryMeta.label.toLowerCase()} codes.`;

const crumbs = [
  { label: 'Home', href: '/' },
  { label: industryMeta.label, href: industryMeta.href },
  { label: 'Error Codes', href: `/${industry}/error-codes/` },
  { label: entry.data.code, href: `/${industry}/error-codes/${entry.slug}/` },
];

const canonicalPath = `/${industry}/error-codes/${entry.slug}/`;
const canonicalUrl = new URL(canonicalPath, Astro.site).toString();
const relatedSlugs = pickRelatedSlugs(entries.map((e) => e.slug), entry.slug);
const schema = [breadcrumbSchema(crumbs, canonicalUrl), webPageSchema({ name: pageTitle, canonicalUrl, dateModified: entry.data.lastmod })];
---

<BaseLayout title={pageTitle} description={description} canonicalPath={canonicalPath} schema={schema}>
  <div class="space-y-8">
    <Breadcrumbs items={crumbs} />

    <header class="space-y-6 border-b border-brand-border pb-8">
      <div>
        <div class="mb-2 inline-flex items-center rounded-full border border-brand-border bg-brand-surface px-3 py-1 text-xs font-medium text-slate-400">
            {industryMeta.label} Error Code
        </div>
        <h1 class="text-4xl font-extrabold tracking-tight text-white md:text-5xl">
            <span class="text-brand-primary">{entry.data.code}</span>
            <span class="mx-3 text-slate-600 font-light">|</span>
            <span class="text-slate-200">{entry.data.shortLabel}</span>
        </h1>
      </div>
      
      <div class="grid gap-4 rounded-xl border border-brand-border bg-brand-surface/50 p-6 text-sm text-slate-400 md:grid-cols-3">
        <div>
          <div class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Industry</div>
          <div class="text-slate-200 font-medium">{industryMeta.label}</div>
        </div>
        <div>
          <div class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Canonical URL</div>
          <div class="text-slate-200 font-mono text-xs break-all">{canonicalPath}</div>
        </div>
        <div>
          <div class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Last Updated</div>
          <div class="text-slate-200 font-medium">{new Date(entry.data.lastmod).toLocaleDateString()}</div>
        </div>
      </div>
    </header>

    {entry.data.summary ? (
      <section class="rounded-xl border-l-4 border-brand-primary bg-brand-surface p-6 shadow-md">
        <h2 class="text-sm font-bold uppercase tracking-wide text-brand-primary mb-2">Summary</h2>
        <p class="text-lg text-slate-200 leading-relaxed">{entry.data.summary}</p>
      </section>
    ) : null}

    <AdSlot slot="after-summary" />

    <article class="prose prose-invert prose-slate max-w-none prose-headings:text-white prose-a:text-brand-primary prose-a:no-underline hover:prose-a:underline prose-strong:text-white prose-code:text-brand-accent prose-code:bg-brand-surface prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none">
      <Content />
    </article>

    <AdSlot slot="mid-content" />

    <section class="mt-12 rounded-xl border border-brand-border bg-brand-surface p-8 shadow-card">
      <h2 class="text-xl font-bold text-white mb-6">Related {industryMeta.label} Codes</h2>
      {relatedSlugs.length === 0 ? (
        <div class="text-sm text-slate-500">No related codes available.</div>
      ) : (
        <ul class="grid gap-4 sm:grid-cols-2">
          {relatedSlugs.map((slug) => {
            const rel = entries.find((e) => e.slug === slug);
            if (!rel) return null;
            return (
              <li>
                <a class="group block rounded-lg border border-brand-border bg-brand-dark p-4 hover:border-brand-primary/50 hover:shadow-glow transition-all" href={`/${industry}/error-codes/${rel.slug}/`}>
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-mono text-sm font-bold text-brand-primary group-hover:text-white transition-colors">{rel.data.code}</span>
                    <span class="text-xs text-slate-600 group-hover:text-slate-500">Code</span>
                  </div>
                  <div class="text-sm text-slate-400 group-hover:text-slate-200 line-clamp-2">{rel.data.shortLabel}</div>
                </a>
              </li>
            );
          })}
        </ul>
      )}
    </section>

    <AdSlot slot="near-bottom" />
  </div>
</BaseLayout>
